<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Wolfshoes Configurator</title>
    <link rel="stylesheet" type="text/css" href="style/app.css">

    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
</head>

<body>
    <header class="header">
        <h1 class="header--logo">
                <span>Wolfshoes Configurator</span>
        </h1>
    </header>

    <div class="app">
        <div class="panel">
            <div class="viewer">
                <iframe src="" id="api-frame" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" width="640" height="480"></iframe>

            </div>
            <div class="sidebar">
                <ul class="options">
                </ul>
            </div>
        </div>
    </div>

    <script>
        var switchablePrefixes = ['ROCKET', 'LABLE'];

        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        var iframe = document.getElementById('api-frame');
        var url = getParameterByName('urlid');
        var prefix = getParameterByName('prefix');
        var DEFAULT_URLID = '74d83d112cdd4597bbcd5ca898d1ab44';
        var DEFAULT_PREFIX = 'seat ';
        var CONFIG = {
            urlid: url !== '' ? url : DEFAULT_URLID,
            prefix: prefix !== '' ? prefix : DEFAULT_PREFIX
        };

        var Configurator = {
            api: null,
            config: null,
            options: [],

            /**
             * Initialize viewer
             */
            init: function (config, iframe) {
                this.config = config;
                var client = new Sketchfab(iframe);
                client.init(config.urlid, {
                    ui_infos: 0,
                    ui_controls: 0,
                    graph_optimizer: 0,
                    success: function onSuccess(api) {
                        api.start();
                        api.addEventListener('viewerready', function () {
                            this.api = api;
                            this.initializeOptions(function () {
                                UI.init(this.config, this.options);
                            }.bind(this));
                        }.bind(this));
                    }.bind(this),
                    error: function onError() {
                        console.log('Viewer error');
                    }
                });
            },

            /**
             * Initialize options from scene
             */
            initializeOptions: function initializeOptions(callback) {
                this.api.getNodeMap((err, nodes) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    var node;
                    var isOptionObject = false;
                    var keys = Object.keys(nodes);
                    for (var i = 0; i < keys.length; i++) {
                        node = nodes[keys[i]];
                        isOptionObject = (node.type === 'Geometry' || node.type === 'Group');
                        if (isOptionObject) {
                            console.log('Found the following node:', node);
                            var foundPrefix = switchablePrefixes.find(prefix => node.name.startsWith(prefix));
                            if (foundPrefix) {
                                var opt = this.options.find(opt => opt.name === foundPrefix);
                                if (opt) {
                                    opt.nodeIds.push(node.instanceID);
                                } else {
                                    this.options.push({
                                        nodeIds: [node.instanceID],
                                        name: foundPrefix,
                                        selected: true
                                    });
                                }
                            }
                        }
                    }
                    callback();
                });
            },

            /**
             * Select option to show
             */
            selectOption: function selectOption(index) {
                var option = this.options[index];

                if (option.selected) {
                    option.selected = false;
                    for (var j = 0; j < option.nodeIds.length; j++) {
                        this.api.hide(option.nodeIds[j]);
                    }
                } else {
                    option.selected = true;
                    for (var j = 0; j < option.nodeIds.length; j++) {
                        this.api.show(option.nodeIds[j]);
                    }
                }
            }
        }

        var UI = {
            config: null,
            options: null,
            init: function init(config, options) {
                this.config = config;
                this.options = options;
                this.el = document.querySelector('.options');
                this.render();
                this.el.addEventListener('change', function (e) {
                    e.preventDefault();
                    var index = parseInt(e.srcElement.value, 10);
                    this.select(index);
                }.bind(this));
            },

            select: function (index) {
                Configurator.selectOption(index);
                this.render();
            },

            render: function () {
                if (this.config.urlid === DEFAULT_URLID) {
                    this.renderRadio();
                } else {
                    this.renderSelect();
                }
            },

            /**
             * Render options as multiple `<input type="checkbox">`
             */
            renderRadio: function render() {
                var html = this.options.map(function (option, i) {
                    var checkedState = option.selected ? 'checked="checked"' : '';
                    var className = option.name.replace(this.config.prefix, '');
                    return [
                        '<li><label>',
                        '<input type="checkbox" name="part_' + option.name +'" value="' + i + '" ' + checkedState + '>',
                        '<span class="' + className + '">' + option.name + '</span>',
                        '</label></li>'
                    ].join('');
                }.bind(this)).join('');
                this.el.innerHTML = html;
            },

            /**
             * Render option as `<select>`
             */
            renderSelect: function () {
                var html = this.options.map(function (option, i) {
                    var checkedState = option.selected ? 'selected="selected"' : '';
                    return [
                        '<option value="' + i + '" ' + checkedState + '>',
                        option.name,
                        '</option>',
                    ].join('');
                }).join('');
                this.el.innerHTML = '<select name="color">' + html + '</select>';
            }
        }

        Configurator.init(CONFIG, iframe);
    </script>
</body>

</html>