<!DOCTYPE HTML>
<html>

<head>
    <meta charset="UTF-8">
    <title>Wolfshoes Configurator</title>
    <link rel="stylesheet" type="text/css" href="style/app.css">

    <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>
</head>

<body>
    <header class="header">
        <h1 class="header--logo">
                <span>Wolfshoes Configurator</span>
        </h1>
    </header>

    <div class="app">
        <div class="panel">
            <div class="viewer">
                <iframe src="" id="api-frame" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" width="640" height="480"></iframe>

            </div>
            <div class="sidebar" style="max-width: 100vw; overflow: auto;">
                <ul class="options">
                </ul>
                <div class="config">

                </div>
            </div>
        </div>
    </div>

    <script>
        var switchablePrefixes = ['ROCKET', 'LABLE'];
        var materialsList = [
            {
                id: 'fabric',
                name: 'Fabric',
                colors: [
                    {
                        id: 'blue',
                        name: 'Blue',
                        value: [0.204, 0.365, 0.647],
                    },
                    {
                        id: 'green',
                        name: 'Green',
                        value: [0.227, 0.459, 0.294],
                    },
                ],
                fromMaterial: 'INSIDE',
                textures: {
                    RoughnessPBR: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/Fabric041_4K_Roughness.jpg' },
                    NormalMap: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/Fabric041_4K_Normal.jpg' },
                }
            },
            {
                id: 'rope',
                name: 'Rope',
                colors: [
                    {
                        id: 'black',
                        name: 'Black',
                        value: [0.0, 0.0, 0.0],
                    },
                    {
                        id: 'white',
                        name: 'White',
                        value: [0.95, 0.95, 0.95],
                    },
                ],
                fromMaterial: 'LACES',
                textures: {
                    NormalMap: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/FabricRope001_NRM_3K.jpg' },
                    AOPBR: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/FabricRope001_AO_3K.jpg' },
                    GlossinessPBR: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/FabricRope001_GLOSS_3K.jpg' },
                }
            },
            {
                id: 'leather',
                name: 'Leather',
                colors: [
                    {
                        id: 'pink',
                        name: 'Pink',
                        value: [0.651, 0.137, 0.139],
                    },
                    {
                        id: 'brown',
                        name: 'Brown',
                        value: [0.183, 0.054, 0.0057],
                    },
                ],
                fromMaterial: 'TOUNG',
                textures: {
                    RoughnessPBR: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/leather_red_02_rough_4k.jpg' },
                    NormalMap: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/leather_red_02_nor_4k.jpg' },
                    AOPBR: { url: 'https://osharper.github.io/wulfshoes-configurator/textures/leather_red_02_ao_4k.jpg' },
                }
            }
        ];

        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        var iframe = document.getElementById('api-frame');
        var url = getParameterByName('urlid');
        var prefix = getParameterByName('prefix');
        var DEFAULT_URLID = '74d83d112cdd4597bbcd5ca898d1ab44';
        var CONFIG = {
            urlid: url !== '' ? url : DEFAULT_URLID,
        };

        var Configurator = {
            api: null,
            config: null,

            options: [],
            materializedParts: [],

            materials: [],

            /**
             * Initialize viewer
             */
            init: function (config, iframe) {
                this.config = config;
                var client = new Sketchfab(iframe);
                client.init(config.urlid, {
                    ui_infos: 0,
                    ui_controls: 0,
                    graph_optimizer: 0,
                    success: function onSuccess(api) {
                        api.start();
                        api.addEventListener('viewerready', function () {
                            this.api = api;
                            this.initializeOptions(function () {
                                UI.init(this.config, this.options, this.materializedParts);
                            }.bind(this));

                            this.initializeMaterialOptions(function () {
                                console.log('Materials loaded');
                            }.bind(this));
                        }.bind(this));
                    }.bind(this),

                    error: function onError() {
                        console.log('Viewer error');
                    }
                });
            },

            addTexture: function addTexture(texture, callback) {
                this.api.addTexture(texture.url, (err, id) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    texture.uid = id;
                    callback && callback();
                });
            },
            /**
             * Initialize options from scene
             */
            initializeOptions: function initializeOptions(callback) {
                this.api.getNodeMap((err, nodes) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    var node;
                    var isOptionObject = false;
                    var keys = Object.keys(nodes);
                    for (var i = 0; i < keys.length; i++) {
                        node = nodes[keys[i]];
                        isOptionObject = (node.type === 'Geometry' || node.type === 'Group');
                        if (isOptionObject) {
                            console.log('Found the following node:', node);

                            if (node.materialID) {
                                this.materializedParts.push({ name: node.name, node, materialID: node.materialID });
                            }

                            var foundPrefix = switchablePrefixes.find(prefix => node.name.startsWith(prefix));
                            if (foundPrefix) {
                                var opt = this.options.find(opt => opt.name === foundPrefix);
                                if (opt) {
                                    opt.nodeIds.push(node.instanceID);
                                } else {
                                    this.options.push({
                                        nodeIds: [node.instanceID],
                                        name: foundPrefix,
                                        selected: true
                                    });
                                }
                            }
                        }
                    }
                    callback();
                });
            },

            initializeMaterialOptions: function initializeMaterialOptions(callback) {
                this.api.getMaterialList((err, materials) => {
                    if (err) {
                        console.error(err);
                        return;
                    }

                    this.materials = materials;

                    materialsList.forEach(m => {
                        if (!m.fromMaterial) return;

                        var material = materials.find(material => material.name === m.fromMaterial);
                        m.template = JSON.parse(JSON.stringify(material));
                        delete m.template.id;
                        delete m.template.name;
                    });

                    callback();
                });
            },

            /**
             * Select option to show
             */
            selectOption: function selectOption(index) {
                var option = this.options[index];

                if (option.selected) {
                    option.selected = false;
                    for (var j = 0; j < option.nodeIds.length; j++) {
                        this.api.hide(option.nodeIds[j]);
                    }
                } else {
                    option.selected = true;
                    for (var j = 0; j < option.nodeIds.length; j++) {
                        this.api.show(option.nodeIds[j]);
                    }
                }
            },

            setDefaultMaterial: function setDefaultMaterial(partId) {
                var part = this.materializedParts.find(function (p) {
                    return p.name === partId;
                });

                this.api.assignMaterial(part.node, part.materialID);
            },

            changeMaterial: function changeMaterial(partId, textureId, colorId) {
                var texture = materialsList.find(function (material) {
                    return material.id.toLowerCase() === textureId.toLowerCase();
                });

                if (!texture) {
                    console.error('Texture not found', textureId);
                    return;
                }

                var color = texture.colors.find(function (color) {
                    return color.id.toLowerCase() === colorId.toLowerCase();
                });

                if (!color) {
                    console.error('Color not found', colorId);
                    return;
                }


                var part = this.materializedParts.find(function (p) {
                    return p.name === partId;
                });

                if (!part) {
                    console.error('Part not found', partId);
                    return;
                }

                var material = this.materials.find(function (material) {
                    return material.id === part.materialID;
                });

                if (!material) {
                    console.error('Material not found', part.materialID);
                    return;
                }

                var copy = JSON.parse(JSON.stringify(texture.template));
                copy.name = part.name + '_' + textureId + '_' + colorId;

                copy.channels.AlbedoPBR.color = color.AlbedoPBR || color.value;
                copy.channels.DiffuseColor.color = color.DiffuseColor || color.value;
                copy.channels.SpecularColor.color = color.SpecularColor || color.value;
                copy.channels.DiffusePBR.color = color.DiffusePBR || color.value;
                // for (var key in texture.textures) {
                //     copy.channels[key] = {
                //         "enable": true,
                //         "factor": 1,
                //         "flipY": true,
                //         "UVTransforms": {
                //             "scale": [1, 1],
                //             "offset": [0, 0],
                //             "rotation": 0
                //         },
                //         "texture": {
                //             "magFilter": "LINEAR",
                //             "minFilter": "LINEAR_MIPMAP_LINEAR",
                //             "wrapS": "REPEAT",
                //             "wrapT": "REPEAT",
                //             "textureTarget": "TEXTURE_2D",
                //             "internalFormat": "RGB",
                //             "uid": texture.textures[key].uid,
                //         }
                //     };
                // }

                this.api.createMaterial(copy, function(err, newMaterial) {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    this.materials.push(newMaterial);
                    this.api.assignMaterial(part.node, newMaterial.id);
                }.bind(this));
            }
        }

        var UI = {
            config: null,
            options: null,
            init: function init(config, options, materializedParts) {
                this.config = config;
                this.options = options;

                var el = document.querySelector('.options');
                this.render(el, options);
                el.addEventListener('change', function (e) {
                    e.preventDefault();
                    var index = parseInt(e.srcElement.value, 10);
                    this.select(index);
                }.bind(this));

                el = document.querySelector('.config');
                this.renderConfig(el, materializedParts);
            },

            select: function (index) {
                Configurator.selectOption(index);
            },

            render: function (el, options) {
                if (this.config.urlid === DEFAULT_URLID) {
                    this.renderCheckbox(el, options);
                } else {
                    this.renderSelect(el, options);
                }
            },

            renderConfig: function (el, materializedParts) {
                var html = materializedParts.map(function (part) {
                    return [
                        '<div class="config__part">',
                        '<input type="hidden" name="partId" value="' + part.name + '"> ',
                        '<h2>' + part.name + '</h2>',
                        '<div class="config__part__material">',
                        '<div class="config__part__material__texture">',
                        '<span>Texture</span>',
                        '<select name="texture">',
                        '<option value="none">Default</option>',
                        '<option value="fabric">Fabric</option>',
                        '<option value="rope">Rope</option>',
                        '<option value="leather">Leather</option>',
                        '</select>',
                        '</div>',
                        '<div class="config__part__material__color">',
                        '<span>Color</span>',
                        '<select name="color">',
                        '<option value="-1">Default</option>',
                        '</select>',
                        '</div>',
                        '</div>',
                        '</div>'
                    ].join('');
                }.bind(this)).join('');
                el.innerHTML = html;

                el.addEventListener('change', function (e) {
                    e.preventDefault();
                    var name = e.srcElement.name;
                    var value = e.srcElement.value;

                    var partRootEl = e.srcElement.parentElement.parentElement.parentElement;
                    var partId = partRootEl.querySelector('input[name="partId"]').value;

                    if (name == 'texture') {
                        var texture = materialsList.find(function (material) {
                            return material.id.toLowerCase() === value.toLowerCase();
                        });

                        if (!texture) {
                            Configurator.setDefaultMaterial(partId);
                        }

                        this.renderColorOptions(partRootEl.querySelector('select[name="color"]'), (texture && texture.colors) || []);
                    } else if (name == 'color') {
                        var textureId = partRootEl.querySelector('select[name="texture"]').value;
                        var color = value.toLowerCase();

                        Configurator.changeMaterial(partId, textureId, color);
                    }
                }.bind(this));
            },

            /**
             * Render options as multiple `<input type="checkbox">`
             */
            renderCheckbox: function render(el, options) {
                var html = options.map(function (option, i) {
                    var checkedState = option.selected ? 'checked="checked"' : '';
                    var className = option.name;
                    return [
                        '<li><label>',
                        '<input type="checkbox" name="part_' + option.name +'" value="' + i + '" ' + checkedState + '>',
                        '<span class="' + className + '">' + option.name + '</span>',
                        '</label></li>'
                    ].join('');
                }.bind(this)).join('');
                el.innerHTML = html;
            },

            /**
             * Render option as `<select>`
             */
            renderSelect: function (el, options) {
                var html = options.map(function (option, i) {
                    var checkedState = option.selected ? 'selected="selected"' : '';
                    return [
                        '<option value="' + i + '" ' + checkedState + '>',
                        option.name,
                        '</option>',
                    ].join('');
                }).join('');
                el.innerHTML = '<select name="color">' + html + '</select>';
            },

            renderColorOptions: function (el, colors) {
                var html = colors.map(function (color, i) {
                    var checkedState = color.selected ? 'selected="selected"' : '';
                    return [
                        '<option value="' + color.id + '" ' + checkedState + '>',
                        color.name,
                        '</option>',
                    ].join('');
                }).join('');
                el.innerHTML = '<option value="none" selected="selected">Select color</option>' + html;
            }
        }

        Configurator.init(CONFIG, iframe);
    </script>
</body>

</html>